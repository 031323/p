#include "पर्वयन्त्रम्.h"

#include <malloc.h>
#include <stdio.h>

typedef पर्व *पर्वनिर्देशः;

/*
त्रिविधानिपर्वाणि।
प्रथमंसवामदक्षिणनिर्देशंसाधारणम्।
द्वितीयम्प्रयोगरूपम्। यस्यवामेप्रयोज्यम्। दक्षिणेप्रयोगविषयः। अन्यच्चैकमतिदेशपर्व। एतानित्रीणिनिर्दिश्यन्ते।
तृतीयन्निर्दिष्टात्मकम्पर्व। प्रयोगेनिष्पादितेसतियत्फलन्तदात्मकत्वमनेनप्रतिपाद्यते। तत्फलंवामेनिर्दिश्यते। शुद्धनिर्देशस्यस्थानेतदेवफलङ्ग्राह्यते।
*/
typedef enum { साधारणपर्व, प्रयोगपर्व, तदात्मपर्व } पर्वभेदः;
typedef पर्वभेदः *पर्वभेदनिर्देशः;
typedef unsigned long int गणना;

/* आंनवेति। सदसती। इत्येतानर्थान्प्रतिपादयितुमिदम्। */
typedef char द्वैधम्;

/* कस्यापिपर्वणोनिर्देशोदीयते। निर्दिष्टंसाधारणञ्चेत्तदेवप्रतिग्राह्यते। प्रयोगश्चेन्निष्पाद्यतङ्ग्राह्यते। निर्दिष्टात्मकञ्चेतन्निर्दिष्टङ्ग्राह्यते। */
static पर्व शुद्धम्(const पर्वनिर्देशः);

#define सत् 1
#define असत् 0

/*
स्मृतौपर्वणोगुणानांविन्यासःकथन्तदत्रनिरूप्यते।
आदौपर्वभेदः। ततःसङ्ख्या।  वामम्। दक्षिणम्। अतिदेशः। इत्येवम्।
पर्वभेदःसाधारणप्रयोगतदात्मकानामेकतमः।
किमपिपर्वात्मनोदक्षिणेवामेतिदेशत्वेनवानिर्दिष्टेषुपर्वस्वालम्बितमितिकथ्यते। सेयमस्यालम्बिनांसङ्ख्या। यस्यालम्बीनिनसन्तितदविलम्बितम्मार्ज्यते।
वाममितिवामस्यपर्वणोनिर्देशः। दक्षिणन्दक्षिणस्य। प्रयोगपर्वास्तिचेत्ततोतिदेशनिर्देशः।
*/
#define भेदः(पर्वविशेषः) (* (पर्वभेदनिर्देशः) पर्वविशेषः)

/* विन्यासेयत्रस्थितिस्तस्यानिर्देशाइमे। */
#define सङ्ख्यानिर्देशः(पर्वविशेषः) (पर्वविशेषः + sizeof (पर्वभेदः))
#define वामनिर्देशः(पर्वविशेषः) (सङ्ख्यानिर्देशः (पर्वविशेषः) + sizeof (गणना))
#define दक्षिणनिर्देशः(पर्वविशेषः) (वामनिर्देशः (पर्वविशेषः) + sizeof (पर्व))
#define अतिदेशनिर्देशः(पर्वविशेषः) (दक्षिणनिर्देशः (पर्वविशेषः) + sizeof (पर्व))

#define सङ्ख्या(पर्वविशेषः) (* (गणना *) (सङ्ख्यानिर्देशः (पर्वविशेषः)))
#define वामम्(पर्वविशेषः) (* (पर्वनिर्देशः) वामनिर्देशः (पर्वविशेषः))
#define दक्षिणम्(पर्वविशेषः) (* (पर्वनिर्देशः) दक्षिणनिर्देशः (पर्वविशेषः))
#define शुद्धवामम्(पर्वविशेषः) (शुद्धम् (वामनिर्देशः (पर्वविशेषः)))
#define शुद्धदक्षिणम्(पर्वविशेषः) (शुद्धम् (दक्षिणनिर्देशः (पर्वविशेषः)))
#define अतिदेशः(पर्वविशेषः) (* (पर्वनिर्देशः) अतिदेशनिर्देशः (पर्वविशेषः))
#define असाधारणम्(पर्वविशेषः) (भेदः (पर्वविशेषः) != साधारणपर्व)
#define प्रयोगः(पर्वविशेषः) (भेदः (पर्वविशेषः) == प्रयोगपर्व)
#define तदात्मकम्(पर्वविशेषः) (भेदः (पर्वविशेषः) == तदात्मपर्व)
#define पर्वपरिमाणम् (sizeof (पर्वभेदः) + sizeof (गणना) + 3 * sizeof (पर्व))

/* स्मृतौपरिमितमेवस्थानङ्गृह्यते। अनालम्बीनिपर्वाणियथाकालम्मार्ज्यन्ते। इतिपरीक्षितुमयव्ँव्यवसायः। */
#ifdef परीक्षणम्
int स्थानपरिमाणम् = 0;
#endif

/* उपक्रमेधोदत्तानाम्पर्वाणाङ्कृतेस्मृतौस्थानमुपकल्प्यारक्ष्यते। उपक्रमविधिःपश्चाद्दत्तः। */
द्वैधम् उपक्रान्तम् = असत्;
पर्व मूलम्, वामकम्, दक्षिणकम्, तद्रूपकम्, समत्वकम्, स्थानिकम्, अतिदेशकम्, प्रयोजकम्, बाह्यकम्;

static void क्षयः(const पर्व p, const द्वैधम् निःशेषतस्त्वम्)
{
	if (p && (!निःशेषतस्त्वम् || !--(सङ्ख्या(p)))) {

		#define अवयवक्षयः(a) क्षयः (a (p), 1)

		अवयवक्षयः(वामम्);
		अवयवक्षयः(दक्षिणम्);
		अवयवक्षयः(अतिदेशः);

		#undef अवयवक्षयः

		if (निःशेषतस्त्वम्) {
			free(p);

		#ifdef परीक्षणम्

			स्थानपरिमाणम्--;
			printf("%d\n", स्थानपरिमाणम्);

		#endif
		}
	}
}

static void आलम्बिक्षयः(const पर्व p)
{
	क्षयः(p, 1);
}

static void आलम्बिवृृद्धिः(const पर्व p)
{
	if (p)
		सङ्ख्या(p)++;
}

void मार्जनम्(const पर्व p)
{
	if (p && (p < तद्रूपकम् || p > तद्रूपकम् + 8 * पर्वपरिमाणम् || सङ्ख्या(p) > 1))
		आलम्बिक्षयः(p);
}

static void पर्वपर्ययः(const पर्व p, const पर्वभेदः b, const पर्व v, const पर्व d, const पर्व a, const द्वैधम् सक्षयत्वम्)
{
	भेदः(p) = b;
	आलम्बिवृृद्धिः(v);
	आलम्बिवृृद्धिः(d);
	आलम्बिवृृद्धिः(a);
	if (सक्षयत्वम्)
		क्षयः(p, असत्);
	वामम्(p) = v;
	दक्षिणम्(p) = d;
	अतिदेशः(p) = a;
}

static पर्व नवम्(const पर्वभेदः b, const गणना s, const पर्व v, const पर्व d, const पर्व a)
{
	पर्व p = malloc(पर्वपरिमाणम्);

	#ifdef परीक्षणम्

	स्थानपरिमाणम्++;
	printf("%d\n", स्थानपरिमाणम्);

	#endif

	सङ्ख्या(p) = s;
	पर्वपर्ययः(p, b, v, d, a, असत्);
	return p;
}

static पर्व नवसातिदेशप्रयोगः(const पर्व v, const पर्व d, const पर्व a)
{
	return नवम्(प्रयोगपर्व, 0, v, d, a);
}

पर्व नवप्रयोगः(const पर्व v, const पर्व d)
{
	पर्व p = नवम्(प्रयोगपर्व, 1, v, d, NULL);
	return शुद्धम्(&p);
}

पर्व नवपर्व(const पर्व v, const पर्व d)
{
	return नवम्(साधारणपर्व, 1, v, d, NULL);
}

static void साधारणीकरणम्(const पर्व p, const पर्व v, const पर्व d)
{
	पर्वपर्ययः(p, साधारणपर्व, v, d, NULL, सत्);
}

static void तद्रूपीकरणम्(const पर्व p, const पर्व t)
{
	पर्वपर्ययः(p, तदात्मपर्व, t, NULL, NULL, सत्);
}

static void प्रयोगपर्ययः(const पर्व p, const पर्व v, const पर्व d, const पर्व a)
{
	पर्वपर्ययः(p, प्रयोगपर्व, v, d, a, सत्);
}

static void उपक्रमः()
{
	if (!उपक्रान्तम्) {
		उपक्रान्तम् = 1;
		पर्व p = malloc(पर्वपरिमाणम् * 8);

		#define संस्कारः(s)\
			s = p;\
			p += पर्वपरिमाणम्;\
			सङ्ख्या (s) = 1;\
			पर्वपर्ययः (s, साधारणपर्व, NULL, NULL, NULL, असत्)

		संस्कारः(वामकम्);
		संस्कारः(दक्षिणकम्);
		संस्कारः(तद्रूपकम्);
		संस्कारः(समत्वकम्);
		संस्कारः(स्थानिकम्);
		संस्कारः(अतिदेशकम्);
		संस्कारः(प्रयोजकम्);
		संस्कारः(बाह्यकम्);

		#undef संस्कारः
		
		मूलम् = नवपर्व(तद्रूपकम्, नवपर्व(समत्वकम्, नवपर्व(स्थानिकम्, नवपर्व(अतिदेशकम्, नवपर्व(प्रयोजकम्, नवपर्व(बाह्यकम्, असत्))))));
	}
}

पर्व मूलपर्व()
{
	उपक्रमः();
	return मूलम्;
}

पर्व वामकपर्व()
{
	उपक्रमः();
	return वामकम्;
}

पर्व दक्षिणकपर्व()
{
	उपक्रमः();
	return दक्षिणकम्;
}

static पर्व शुद्धम्(const पर्वनिर्देशः शोध्यनिर्देशः)
{
	पर्व s;
	while ((s = *शोध्यनिर्देशः) && असाधारणम्(s)) {
		if (प्रयोगः(s)) {
			const पर्व v = शुद्धवामम्(s);
			if (!v)
				तद्रूपीकरणम्(s, NULL);
			else if (v == तद्रूपकम्)
				तद्रूपीकरणम्(s, दक्षिणम्(s));

			#define असतिकार्यम्(p) if (! p)\
				तद्रूपीकरणम्(s, NULL);
			#define अवयवः(n, a)\
				else if (v == n) {\
					const पर्व d = शुद्धदक्षिणम् (s);\
					असतिकार्यम् (d)\
					else\
						तद्रूपीकरणम् (s, a (d));\
				}

			अवयवः(वामकम्, वामम्)
			अवयवः(दक्षिणकम्, दक्षिणम्)
			
			#undef अवयवः

			else if (v == स्थानिकम्) {
				const पर्व a = अतिदेशः(s);
				प्रयोगपर्ययः(s, a, दक्षिणम्(s), a);
			} else {
				const पर्व vv = शुद्धवामम्(v);
				if(vv == समत्वकम्) {
					पर्व  p = नवम्(प्रयोगपर्व, 1, दक्षिणम्(v), दक्षिणम्(s), अतिदेशः(s));
					असतिकार्यम्(शुद्धम्(&p))
					else {
						const पर्व dp = शुद्धदक्षिणम्(p);
						असतिकार्यम्(dp)
						else {
							const पर्व vp = शुद्धवामम्(p);
							असतिकार्यम्(vp)
							else {
								if (!vp || शुद्धवामम्(vp) == शुद्धदक्षिणम्(vp))
									तद्रूपीकरणम्(s, वामम्(dp));
								else
									तद्रूपीकरणम्(s, दक्षिणम्(dp));
							}
						}
					}
					मार्जनम्(p);
				} else if (vv == अतिदेशकम्) {
					const पर्व dv = दक्षिणम्(v);
					प्रयोगपर्ययः(s, dv, दक्षिणम्(s), dv);
				} else if (vv == प्रयोजकम्) {
					const पर्व dv = शुद्धदक्षिणम्(v);
					असतिकार्यम्(dv)
					else {
						const पर्व d = दक्षिणम्(s), a = अतिदेशः(s);
						प्रयोगपर्ययः(s, नवसातिदेशप्रयोगः(वामम्(dv), d, a), नवसातिदेशप्रयोगः(दक्षिणम्(dv), d, a), a);
					}
				} else if (vv == बाह्यकम्)
					तद्रूपीकरणम्(s, दक्षिणम्(v));
				else {
					const पर्व d = दक्षिणम्(s), a = अतिदेशः(s);
					साधारणीकरणम्(s, नवसातिदेशप्रयोगः(vv, d, a), नवसातिदेशप्रयोगः(दक्षिणम्(v), d, a));
				}
			}
			
			#undef असतिकार्यम्
			
		} else if (तदात्मकम्(s)) {
			const पर्व t = वामम्(s);
			आलम्बिवृृद्धिः(t);
			आलम्बिक्षयः(s);
			*शोध्यनिर्देशः = t;
		}
	}
	return s;
}
